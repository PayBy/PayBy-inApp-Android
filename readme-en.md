# PayBy-inApp-Android
PayBy Payment Gateway integration SDK for android with In-app pay scenes
## Term Definition
- IAPDeviceId：every device has its own unique deviceId 
- IAPPartnerId：assigned a partnerId  while applying for the payment
- IAPAppId：assigned an appId while applying for the payment
- OrderToken：it contains order information
- IAPSign：generated by customer server with IAPDeviceId、IAPPartnerId、IAPAppId、OrderToken.The order and the rule of signString show as the following：String signString ="iapAppId="+iapAppId+ "&iapDeviceId=" + iapDeviceId+ "&iapPartnerId=" + iapPartnerId+"&token=" + token ;How to sign the signString,you can see the demo
## Add Dependencies
Use gradle to add dependencies,and Also you should add manifestPlaceholders for downloading APK.
#### Step1:Add Repositories Address
add repositories address in  **build.gradle**  e below the level of the **root project**
```
buildscript{
    repositories {
        google()
        jcenter()
        maven {
            credentials {
                username 'dev'
                password 'dev@123'
            }
            url("http://nexus.payby.com/repository/android-release/")
        }  
    }
}
allprojects {
    repositories {
        google()
        jcenter()
        maven {
            credentials {
                username 'dev'
                password 'dev@123'
            }
            url("http://nexus.payby.com/repository/android-release/")
        }  
    }
}
```
#### Step2: Add Library 
add library dependencies in **build.gradle** below the level of **app module**
```
dependencies{
    ...
    def iap_version="1.0.0-RELEASE"
    implementation "com.payby.lego.android.payment:lib-iap-sdk-view-x:${iap_version}"
}
```
#### Step3: Add Placeholder
add manifestPlaceholders.key is "PACKAGENAME",value is the applicationId of current project.Android System does it by FileProvider below the current project when downloading the APK file.So ,you need  assign the path of Fileprovider according to the applicationId.And also you should support java8.
```
android{
    defaultConfig {
        applicationId "com.payby.android.payment.iap.sample"
        ...
        manifestPlaceholders=[
                PACKAGENAME:"com.payby.android.payment.iap.sample"
        ]
    }
    compileOptions {
        sourceCompatibility JavaVersion.VERSION_1_8
        targetCompatibility JavaVersion.VERSION_1_8
    }
}
```
# Declared Permissions
declare the necessory permissions in manifest.for example:
1.  INTERNET:used for download file.
2. Read/Write SD card: used for storage of SD card.
3. Install Package:allowed to install apk in the application.
```
<manifest xmlns:android="http://schemas.android.com/apk/res/android"
    package="com.payby.android.payment.iap.sample">
    <uses-permission android:name="android.permission.INTERNET" />
    <uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE"/>
    <uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE"/>
    <uses-permission android:name="android.permission.REQUEST_INSTALL_PACKAGES"/>
    <application
       ...
    </application>

</manifest>
```
# Parameters Preparation
it shows what do the parameters mean and how to get them.
| name| descriptioin| how to get |
|:-:|:-:|:-:|
|iapDeviceId|the unique deviceId|get from the api in IAP SDK|
|iapPartnerId|partnerId|assigned an partnerId while applying for the payment|
|token|orderToken|After placing order,you can get from the response|
|iapAppId| appId|assigned an appId while applying for the payment|
|iapSign|the information of sign among iapDeviceId,iapPartnerId,token,iapAppId|generate by the sign rules show as the flowing|

# How To Use
#### Step1: Generate IAPDeviceId
```
PbManager manager = PbManager.getInstance(this);
String mIapDeviceId= manager.getIAPDeviceID();
```
**Notes:When placing order or payment,the IapDeviceId must not be the different.**

#### Step2:Place Oder
you should place order according to the server yourself. You can get  **token**  and  **iapSign**  from the response.
#### Step3:Set The Payment Listener
```
manager.onPayResultListener = this; //  register the OnPayResultListener 
```
#### Step4:Do Payment
You should instantiate the  **PayTask** with the parameters of token,iapdeviceId,partnerId,mSign.the order of them must like this and should not change them.After that ,you can **pay(task,isTest)**, the parameter isTest is a boolean type,it means **testing environment** if true,and false means **production environment**.
```
PayTask task = PayTask.with(mToken, mIapDeviceId, mPartnerId, mSign, mIapAppId);
manager.pay(task, isTest);    
```
#### Step5：Get Payment Result
implements **OnPayResultListener** ，override its method  **onGetPayState(String result)**，then you can get the result
#### Payment Result Code
- SUCCESS: the payee has received the money successfully,and the payment finished
- FAIL：payment fail
- PAID：the payer has paid the money
- PAYING：the payment is dealing

# Sample
The full steps of  intergration sample :
```
public class MainActivity extends AppCompatActivity implements OnPayResultListener {
  EditText et_sign, et_token, et_id, et_deviceId,et_app_id;
  Button pay;
  private PbManager manager;
  private String mToken;  //tokenUrl   
  private String mPartnerId;  //partnerId
  private String mSign;
  private String mIapDeviceId;
  private String mIapAppId;
  private boolean isTest = true; 

  @Override
  protected void onCreate(Bundle savedInstanceState) {
    super.onCreate(savedInstanceState);
    setContentView(R.layout.activity_main);
    pay = findViewById(R.id.pay);
    et_sign = findViewById(R.id.et_sign);
    et_token = findViewById(R.id.et_token);
    et_id = findViewById(R.id.et_id);
    et_deviceId = findViewById(R.id.et_deviceId);
    et_app_id = findViewById(R.id.et_app_id);
  
    // Step1:get PbManager and generate IapDeviceId
    manager = PbManager.getInstance(this);
    
    // Step2: generate the iapDeviceId
    String iapDeviceID = manager.getIAPDeviceID();
    et_deviceId.setText(iapDeviceID);

    // Step3:set the payment result listener
    manager.onPayResultListener = this;
    pay.setOnClickListener(new View.OnClickListener() {
      @Override
      public void onClick(View v) {
        startPay();
      }
    });

  }
  
  // Step4: start to pay
  private void startPay() {
    mToken = et_token.getText().toString().trim();
    mPartnerId = et_id.getText().toString().trim();
    mIapDeviceId = et_deviceId.getText().toString().trim();
    mSign = et_sign.getText().toString().trim();
    mAppId = et_app_id.getText().toString().trim();
    if (TextUtils.isEmpty(mToken)
        || TextUtils.isEmpty(mPartnerId)
        || TextUtils.isEmpty(mIapDeviceId)
        || TextUtils.isEmpty(mSign)
        || TextUtils.isEmpty(mAppId)) {
      Toast.makeText(this, "parameter should not be null", Toast.LENGTH_SHORT).show();
      return;
    }
    
    PayTask task = PayTask.with(mToken, mIapDeviceId, mPartnerId, mSign, mAppId);
    manager.pay(task, isDev);
  }

  @Override
  public void onGetPayState(String s) {
    // Step5: get the payment result,
    if (TextUtils.equals(result, "SUCCESS")) {
      // the payment has finished successfully
    } else if (TextUtils.equals(result, "PAID")) {
    // PAID;payer just has paid successfully
    } else if (TextUtils.equals(result, "PAYING")) {
        // PAYING 
    } else if (TextUtils.equals(result, "FAIL")) {
        // FAIL
    }else{
      // UNKNOW ERROR
    }
  }
}
```





