# PayBy-inApp-Android
PayBy Payment Gateway integration SDK for android with In-app pay scenes
# Download
###### Step1: add repository in project gradle
```
allprojects {
    repositories {
        google()
        jcenter()
        maven {
            credentials {
                username 'snapshot'
                password 'snapshot'
            }
            url("http://nexus.payby.com/repository/android-snapshot/")
        }
        
    }
}
```
###### Step2: add IAP SDK library in app gradle
```
def iap_version="1.0.0-SNAPSHOT-20200523_11_10"
implementation "com.payby.lego.android.payment:lib-iap-sdk-view-x:${iap_version}"
```
###### Step3: add placeholder named "PACKAGENAME",value is applicationId
```
defaultConfig {
        applicationId "com.payby.android.payment.iap.sample"
        minSdkVersion 21
        targetSdkVersion 29
        versionCode 1
        versionName "1.0"

        testInstrumentationRunner "androidx.test.runner.AndroidJUnitRunner"
        manifestPlaceholders=[
                PACKAGENAME:"com.payby.android.payment.iap.sample"
        ]
    }
```
###### Step4: support java8
```
compileOptions {
    sourceCompatibility JavaVersion.VERSION_1_8
    targetCompatibility JavaVersion.VERSION_1_8
}
```
# Permission
```
<manifest xmlns:android="http://schemas.android.com/apk/res/android"
    package="com.payby.android.payment.iap.sample">
    <uses-permission android:name="android.permission.INTERNET" />
    <uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE"/>
    <uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE"/>
    <uses-permission android:name="android.permission.REQUEST_INSTALL_PACKAGES"/>
    <application
        android:allowBackup="true"
        android:roundIcon="@mipmap/ic_launcher_round"
        android:supportsRtl="true"
        android:theme="@style/AppTheme">
        <activity android:name=".MainActivity">
            <intent-filter>
                <action android:name="android.intent.action.MAIN" />
                <category android:name="android.intent.category.LAUNCHER" />
            </intent-filter>
        </activity>
    </application>

</manifest>
```
# Parameters Description
| name | description | how to get |
|:-:|:-:|:-:|
|iapDeviceId|String|Created by IAP SDK|
|iapPartnerId|String|Distributed by Payby Server|
|token|String|Created by Payby Server|
|iapSign|String|Generated by Merchant Server|
|iapAppId|String|Distributed by Payby Server|
# How To Use
###### Step1:create iapDeviceId
```
PbManager manager = PbManager.getInstance(this);
```
Then,you can place order,After creating one payment order,you can get some informations from yourself server,such as token、iapSign、iapPartnerId.

###### Step2:create payment task
```
PayTask task = PayTask.with(mToken, mIapDeviceId, mPartnerId, mSign, mIapAppId);
```
###### Step3:start to pay
```
manager.pay(task, isDev);    
```
the second parameter is dev environment or pro environment,default is dev

###### Step4:set payment result listener
```
manager.onPayResultListener = this;
```
# Sample
```
public class MainActivity extends AppCompatActivity implements OnPayResultListener {
  EditText et_sign, et_token, et_id, et_deviceId,et_app_id;
  Button pay;
  private PbManager manager;
  private String mToken;  //tokenUrl   
  private String mPartnerId;  //partnerId
  private String mSign;
  private String mIapDeviceId;
  private boolean isDev = true; //What's the environment?Sim environment fill in true, product environment fill in false.

  @Override
  protected void onCreate(Bundle savedInstanceState) {
    super.onCreate(savedInstanceState);
    setContentView(R.layout.activity_main);
    pay = findViewById(R.id.pay);
    et_sign = findViewById(R.id.et_sign);
    et_token = findViewById(R.id.et_token);
    et_id = findViewById(R.id.et_id);
    et_deviceId = findViewById(R.id.et_deviceId);
    et_app_id = findViewById(R.id.et_app_id);

    //Step1:create PbManager
    manager = PbManager.getInstance(this);

    //Step2:generate iapDeviceId
    String iapDeviceID = manager.getIAPDeviceID();
    et_deviceId.setText(iapDeviceID);

    //Step3:register the payment callback
    manager.onPayResultListener = this;

    //Step4:start to pay

    pay.setOnClickListener(new View.OnClickListener() {
      @Override
      public void onClick(View v) {
        startPay();
      }
    });

  }

  private void startPay() {
    mToken = et_token.getText().toString().trim();
    mPartnerId = et_id.getText().toString().trim();
    mIapDeviceId = et_deviceId.getText().toString().trim();
    mSign = et_sign.getText().toString().trim();
    mAppId = et_app_id.getText().toString().trim();
    if (TextUtils.isEmpty(mToken)
        || TextUtils.isEmpty(mPartnerId)
        || TextUtils.isEmpty(mIapDeviceId)
        || TextUtils.isEmpty(mSign)
        || TextUtils.isEmpty(mAppId)) {
      Toast.makeText(this, "parameter should not be null", Toast.LENGTH_SHORT).show();
      return;
    }
    PayTask task = PayTask.with(mToken, mIapDeviceId, mPartnerId, mSign, mAppId);
    manager.pay(task, isDev);
  }

  @Override
  public void onGetPayState(String s) {
    pay.setText(s);
  }
}
```





