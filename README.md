# PayBy-inApp-Android
PayBy Payment Gateway integration SDK for android with In-app pay scenes
# Download
#### Step1: add maven address in project gradle
```
allprojects {
    repositories {
        google()
        jcenter()
        maven {
            credentials {
                username 'dev'
                password 'dev@123'
            }
            url("http://nexus.payby.com/repository/android-release/")
        }
        
    }
}
```
#### Step2: add IAP SDK library in app gradle
```
def iap_version="1.0.0-RELEASE"
implementation "com.payby.lego.android.payment:lib-iap-sdk-view-x:${iap_version}"
```
#### Step3: add  manifestPlaceholders. name is "PACKAGENAME", value is applicationId.Also need support java8
```
android{
    defaultConfig {
        applicationId "com.payby.android.payment.iap.sample"
        minSdkVersion 21
        targetSdkVersion 29
        versionCode 1
        versionName "1.0"
        manifestPlaceholders=[
                PACKAGENAME:"com.payby.android.payment.iap.sample"
        ]
    }
    compileOptions {
        sourceCompatibility JavaVersion.VERSION_1_8
        targetCompatibility JavaVersion.VERSION_1_8
    }
}
```
# Permission
register necessary permissions in manifest
```
<manifest xmlns:android="http://schemas.android.com/apk/res/android"
    package="com.payby.android.payment.iap.sample">
    <uses-permission android:name="android.permission.INTERNET" />
    <uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE"/>
    <uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE"/>
    <uses-permission android:name="android.permission.REQUEST_INSTALL_PACKAGES"/>
    <application
        android:allowBackup="true"
        android:roundIcon="@mipmap/ic_launcher_round"
        android:supportsRtl="true"
        android:theme="@style/AppTheme">
       ...
    </application>

</manifest>
```
# Parameters Description
| name | description | how to get |
|:-:|:-:|:-:|
|iapDeviceId|String|Created by IAP SDK|
|iapPartnerId|String|Distributed by Payby Server|
|token|String|Created by Payby Server|
|iapSign|String|Generated by Merchant Server|
|iapAppId|String|Distributed by Payby Server|
# How To Use
#### Step1:create PbManager 
```
String mIapDeviceId ="";
PbManager manager = PbManager.getInstance(this);
mIapDeviceId= manager.getIAPDeviceID();
```
note:The iapDeviceId for placing order and payment must be the same.so just get it by this way.
First,you can place an order,After creating an order,you can get some order information from the response,such as tokenUrl、iapSign、iapPartnerId、iapAppId.

#### Step2:create payment task
note：The parameters must be in order like this.The first is token,and the second is iapDeviceId...
```
PayTask task = PayTask.with(mToken, mIapDeviceId, mPartnerId, mSign, mIapAppId);
```
#### Step3:start to pay
```
manager.pay(task, isTest);    
```
the second parameter is a boolean,that means for testing environment or production environment. default value true is for testing.

#### Step4:set payment result listener
```
manager.onPayResultListener = this;
```
# Sample
```
public class MainActivity extends AppCompatActivity implements OnPayResultListener {
  EditText et_sign, et_token, et_id, et_deviceId,et_app_id;
  Button pay;
  private PbManager manager;
  private String mToken;  //tokenUrl   
  private String mPartnerId;  //partnerId
  private String mSign;
  private String mIapDeviceId;
  private String mIapAppId;
  private boolean isTest = true;// true means for testing environment,false means for production environment

  @Override
  protected void onCreate(Bundle savedInstanceState) {
    super.onCreate(savedInstanceState);
    setContentView(R.layout.activity_main);
    pay = findViewById(R.id.pay);
    et_sign = findViewById(R.id.et_sign);
    et_token = findViewById(R.id.et_token);
    et_id = findViewById(R.id.et_id);
    et_deviceId = findViewById(R.id.et_deviceId);
    et_app_id = findViewById(R.id.et_app_id);

    manager = PbManager.getInstance(this);
    String iapDeviceID = manager.getIAPDeviceID();
    et_deviceId.setText(iapDeviceID);
    manager.onPayResultListener = this;
    pay.setOnClickListener(new View.OnClickListener() {
      @Override
      public void onClick(View v) {
        startPay();
      }
    });

  }

  private void startPay() {
    mToken = et_token.getText().toString().trim();
    mPartnerId = et_id.getText().toString().trim();
    mIapDeviceId = et_deviceId.getText().toString().trim();
    mSign = et_sign.getText().toString().trim();
    mAppId = et_app_id.getText().toString().trim();
    if (TextUtils.isEmpty(mToken)
        || TextUtils.isEmpty(mPartnerId)
        || TextUtils.isEmpty(mIapDeviceId)
        || TextUtils.isEmpty(mSign)
        || TextUtils.isEmpty(mAppId)) {
      Toast.makeText(this, "parameter should not be null", Toast.LENGTH_SHORT).show();
      return;
    }
    PayTask task = PayTask.with(mToken, mIapDeviceId, mPartnerId, mSign, mAppId);
    manager.pay(task, isDev);
  }

  @Override
  public void onGetPayState(String s) {
    pay.setText(s);
  }
}
```





